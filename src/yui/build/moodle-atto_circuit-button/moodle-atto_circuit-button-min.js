YUI.add("moodle-atto_circuit-button",function(m,e){var h="atto_circuit",i="storeinrepo",o=/\d+%/,n=M.cfg.wwwroot+"/lib/editor/atto/plugins/circuit/circuit.html",f="circuitpad",r={INPUTSUBMIT:"atto_circuit_submit",HGT:"height: 600px;",WDT:"width: 975px;"};m.namespace("M.atto_circuit").Button=m.Base.create("button",m.M.editor_atto.EditorPlugin,[],{initializer:function(){!this.get("host").canShowFilepicker("media")&&0<this.get(i)||this.addButton({icon:"circuit",iconComponent:"atto_circuit",buttonName:"Circtuit",callback:this._displayDialogue})},_convertImage:function(e){for(var t=(0<=e.split(",")[0].indexOf("base64")?atob:decodeURI)(e.split(",")[1]),e=e.split(",")[0].split(":")[1].split(";")[0],i=new Uint8Array(t.length),o=0;o<t.length;o++)i[o]=t.charCodeAt(o);return new Blob([i],{type:e})},_doInsert:function(e){var o,t,n,i,r,s,a,l,c,d,u,g,p;if(console.log("go1"),t=(o=this).get("host"),n=m.Handlebars.compile('<img src="{{url}}" alt="{{alt}}" {{#if width}}width="{{width}}" {{/if}}{{#if height}}height="{{height}}" {{/if}}{{#if presentation}}role="presentation" {{/if}}{{#if customstyle}}style="{{customstyle}}" {{/if}}{{#if classlist}}class="{{classlist}}" {{/if}}{{#if id}}id="{{id}}" {{/if}}/>'),t.saveSelection(),e=e._event,l=document.getElementById(f).contentWindow.document.getElementById("canvas"),i=o._convertImage(l.toDataURL()),console.log(i),u=i&&i.size&&"image/png"==i.type,console.log(u),u){for(s=(r=t.get("filepickeroptions").image).savepath===undefined?"/":r.savepath,a=new FormData,l=0,c="",d=new XMLHttpRequest,u="",g=Object.keys(r.repositories),e.preventDefault(),e.stopPropagation(),a.append("repo_upload_file",i),a.append("itemid",r.itemid),p=0;p<g.length;p++)if("upload"===r.repositories[g[p]].type){a.append("repo_id",r.repositories[g[p]].id);break}return a.append("env",r.env),a.append("sesskey",M.cfg.sesskey),a.append("client_id",r.client_id),a.append("savepath",s),a.append("ctx_id",r.context.id),l=(new Date).getTime(),c="moodleimage_"+Math.round(1e5*Math.random())+"-"+l,o.getDialogue({focusAfterHide:null}).hide(),t.focus(),t.restoreSelection(),u=n({url:M.util.image_url("i/loading_small","moodle"),alt:M.util.get_string("uploading",h),id:c}),t.insertContentAtFocusPoint(u),o.markUpdated(),d.onreadystatechange=function(){var e,t,i=o.editor.one("#"+c);if(4===d.readyState)if(200===d.status){if(e=JSON.parse(d.responseText)){if(e.error)return i&&i.remove(!0),new M.core.ajaxException(e);(t=e).event&&"fileexists"===e.event&&(t=e.newfile),t=n({url:t.url,presentation:!0}),t=m.Node.create(t),i?i.replace(t):o.editor.appendChild(t),o.markUpdated()}}else m.use("moodle-core-notification-alert",function(){new M.core.alert({message:M.util.get_string("servererror","moodle")})}),i&&i.remove(!0);return!0},d.open("POST",M.cfg.wwwroot+"/repository/repository_ajax.php?action=upload",!0),d.send(a),!0}return!0},_getSelectedImageProperties:function(){var e,t={src:null,alt:null,width:null,height:null},i=this.get("host").getSelectedNodes();return(i=i&&i.filter("img"))&&i.size()?(this._selectedImage=i.item(0),(e=this._selectedImage.getAttribute("width")).match(o)||(e=parseInt(e,10)),(i=this._selectedImage.getAttribute("height")).match(o)||(i=parseInt(i,10)),0!==e&&(t.width=e),0!==i&&(t.height=i),t.src=this._selectedImage.getAttribute("src"),t.alt=this._selectedImage.getAttribute("alt")||"",t):(this._selectedImage=null,!1)},_displayDialogue:function(e,t){var i=this.getDialogue({headerContent:M.util.get_string("circuittitle",h),width:"auto",height:"auto",focusAfterHide:t});e.preventDefault(),i.after("visibleChange",function(){!1===i.getAttrs().visible&&setTimeout(function(){i.reset()},5)}),t=this._getFormContent(t),i.set("bodyContent",t),document.getElementById(f).src=n,i.centerDialogue(),i.show(),this.markUpdated()},_getFormContent:function(e){var t=m.Handlebars.compile('<iframe src="{{isource}}" id="{{iframeID}}" style="{{CSS.HGT}}{{CSS.WDT}}" scrolling="auto" frameborder="0"></iframe><div style="text-align:center"><button class="mdl-align btn btn-primary {{CSS.INPUTSUBMIT}}" id="{{submitid}}" style="{{selectalign}}">{{get_string "insert" component}}</button></div>'),e=m.Node.create(t({elementid:this.get("host").get("elementid"),CSS:r,component:h,clickedicon:e,isource:n,iframeID:f,submitid:"submit"}));return this._form=e,0<this.get(i)?(this._form.one("."+r.INPUTSUBMIT).on("click",this._doInsert,this),console.log("doinsert")):this._form.one("."+r.INPUTSUBMIT).on("click",this._doInsertBase64,this),e},_doInsertBase64:function(e){var t;e.preventDefault(),t=this,e=document.getElementById(f).contentWindow.document.getElementById("canvas"),imgstring=e.toDataURL(),circuit='<img src="'+imgstring+'" />',t.getDialogue({focusAfterHide:null}).hide(),t.editor.focus(),t.get("host").insertContentAtFocusPoint(circuit),t.markUpdated()}},{ATTRS:{storeinrepo:{value:0}}})},"@VERSION@",{requires:["moodle-editor_atto-plugin"]});